// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// 1. ุฅุนุฏุงุฏุงุช ุงููุธุงู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const SHEET_NAMES = {
  STUDENTS: 'students',
  RESULTS: 'scores',
  LEADERBOARD: 'leaderboard'
};

const DEEPSEEK_API_KEY = 'sk-7fa2418e7df642289026bcf65c91adc4';

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// 2. ูุธุงุฆู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

/**
 * ุฅูุดุงุก ุชูุฑูู ุจูุงุบู ุฌุฏูุฏ
 */
function generateBalaghaExercise() {
  const exercises = [
    {
      type: "ุงูุทุจุงู",
      prompt: "ุฃูุดุฆ ุชูุฑููุงู ุนู ุงูุทุจุงู ูุญุชูู ุนูู ุฌููุฉ ุชุญุชูู ุนูู ุทุจุงูุ ูุฃุณุฆูุฉ ูุชุญุฏูุฏู."
    },
    {
      type: "ุงูููุงุจูุฉ", 
      prompt: "ุฃูุดุฆ ุชูุฑููุงู ุนู ุงูููุงุจูุฉ ุงูุจูุงุบูุฉ ูุน ุฃูุซูุฉ ูุฃุณุฆูุฉ ุชุญููููุฉ."
    },
    {
      type: "ุงูุณุฌุน",
      prompt: "ุตูู ุชูุฑููุงู ุนู ุงูุณุฌุน ูุชุถูู ูุตูุตุงู ูุฃุณุฆูุฉ ููุชุนุฑู ุนูู ุงูุณุฌุน."
    },
    {
      type: "ุงูุฌูุงุณ",
      prompt: "ุฃูุดุฆ ุชูุฑููุงู ุนู ุงูุฌูุงุณ ุจุฃููุงุนู ูุน ุฃูุซูุฉ ูุฃุณุฆูุฉ ุชุทุจูููุฉ."
    }
  ];
  
  const exercise = exercises[Math.floor(Math.random() * exercises.length)];
  
  const prompt = `
    ุฃูุช ูุนูู ุจูุงุบุฉ ุนุฑุจูุฉ. ${exercise.prompt}
    
    ุฃุฎุฑุฌ ุงููุชูุฌุฉ ุจุงูุชูุณูู ุงูุชุงูู:
    
    ๐ฏ ููุน ุงูุชูุฑูู: ${exercise.type}
    ๐ ุงูุณุคุงู: [ุถุน ุงูุณุคุงู ููุง]
    ๐ ุงููุต ุฃู ุงููุซุงู: [ุถุน ุงููุต ููุง]
    ๐ง ุงูุฃุณุฆูุฉ: [ุถุน 3 ุฃุณุฆูุฉ ูุฑุนูุฉ]
    โ ุงูุฅุฌุงุจุฉ ุงููููุฐุฌูุฉ: [ุถุน ุงูุฅุฌุงุจุฉ ุงููุงููุฉ]
    ๐ก ุงูุดุฑุญ: [ุงุดุฑุญ ุงูููููู ุงูุจูุงุบู]
    
    ุงุฌุนู ุงูุชูุฑูู ููุงุณุจุงู ูุทูุงุจ ุงููุฑุญูุฉ ุงููุชูุณุทุฉ.
  `;
  
  return callDeepSeekAPI(prompt);
}

/**
 * ุฅูุดุงุก ุชูุฑูู ุฅุนุฑุงุจ ุฌุฏูุฏ
 */
function generateI3rabExercise() {
  const levels = ["ูุจุชุฏุฆ", "ูุชูุณุท", "ูุชูุฏู"];
  const level = levels[Math.floor(Math.random() * levels.length)];
  
  const prompt = `
    ุฃูุช ูุนูู ุฅุนุฑุงุจ ุนุฑุจู. ุฃูุดุฆ ุชูุฑูู ุฅุนุฑุงุจ ูููุณุชูู ${level}.
    
    ุงูุชูุฑูู ูุฌุจ ุฃู ูุญุชูู ุนูู:
    1. ุฌููุฉ ุฃู ุฌููุชูู ุชุญุชุงุฌ ููุฅุนุฑุงุจ
    2. ุฃุณุฆูุฉ ูุญุฏุฏุฉ ุนู ุงูุฅุนุฑุงุจ
    3. ุฅุนุฑุงุจ ููุตู ูููุต
    4. ุดุฑุญ ููููุงุนุฏ ุงููุญููุฉ ุงููุณุชุฎุฏูุฉ
    5. ุฃูุซูุฉ ุฅุถุงููุฉ ูุดุงุจูุฉ
    
    ุฃุฎุฑุฌ ุงููุชูุฌุฉ ุจุงูุชูุณูู:
    
    ๐ฏ ูุณุชูู: ${level}
    ๐ ุงูุฌููุฉ: [ุถุน ุงูุฌููุฉ ููุง]
    โ ุงูุณุคุงู: [ุถุน ุงูุณุคุงู ุงูุฑุฆูุณู]
    ๐ง ุงูุฃุณุฆูุฉ ุงููุฑุนูุฉ: [3 ุฃุณุฆูุฉ]
    โ ุงูุฅุนุฑุงุจ ุงููุงูู: [ุฅุนุฑุงุจ ููุตู]
    ๐ ุดุฑุญ ุงูููุงุนุฏ: [ุดุฑุญ ุงูููุงุนุฏ ุงููุณุชุฎุฏูุฉ]
    ๐ ุฃูุซูุฉ ุฅุถุงููุฉ: [2-3 ุฃูุซูุฉ]
  `;
  
  return callDeepSeekAPI(prompt);
}

/**
 * ุฅูุดุงุก ูุถุนูุฉ ุฅุฏูุงุฌูุฉ ุฌุฏูุฏุฉ
 */
function generateCompositionExercise() {
  const topics = [
    "ุฃูููุฉ ุงููุฑุงุกุฉ",
    "ุงูุชุนุงูู ุจูู ุงูุฃุตุฏูุงุก", 
    "ุญูุงูุฉ ุงูุจูุฆุฉ",
    "ุงูุฑูุงุถุฉ ูุงูุตุญุฉ",
    "ุงูุชูููููุฌูุง ูุงูุชุนููู"
  ];
  
  const topic = topics[Math.floor(Math.random() * topics.length)];
  
  const prompt = `
    ุฃูุช ูุนูู ูุบุฉ ุนุฑุจูุฉ. ุตูู ูุถุนูุฉ ุฅุฏูุงุฌูุฉ ุนู: "${topic}"
    
    ุงููุชุทูุจุงุช:
    1. ุนููุงู ุฌุฐุงุจ
    2. ูุต ูุทููุจ ูู ุงูุทุงูุจ ูุชุงุจุชู (150-200 ูููุฉ)
    3. ูุนุงููุฑ ุงูุชูููู (4 ูุนุงููุฑ ร 25 ููุทุฉ)
    4. ุชูุฌููุงุช ููุทุงูุจ
    5. ูููุฐุฌ ููุฅุฌุงุจุฉ ุงููุซุงููุฉ
    
    ุฃุฎุฑุฌ ุงููุชูุฌุฉ ุจุงูุชูุณูู:
    
    ๐ฏ ุงูููุถูุน: ${topic}
    ๐ ุงูุนููุงู: [ุนููุงู ุฌุฐุงุจ]
    ๐ ุงููุทููุจ: [ุชุนูููุงุช ุงููุชุงุจุฉ]
    ๐ ูุนุงููุฑ ุงูุชูููู:
      - ุตุญุฉ ุงููุบุฉ (25 ููุทุฉ)
      - ุงูุชูุธูู (25 ููุทุฉ)  
      - ุงูุฃููุงุฑ (25 ููุทุฉ)
      - ุงูุฅุจุฏุงุน (25 ููุทุฉ)
    โ ุงููููุฐุฌ ุงููุซุงูู: [ูุต ูุซุงูู]
    ๐ ูุตุงุฆุญ ูููุชุงุจุฉ: [5 ูุตุงุฆุญ]
  `;
  
  return callDeepSeekAPI(prompt);
}

/**
 * ุชุตุญูุญ ุงูุฅุฌุงุจุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
 */
function correctAnswer(exerciseType, question, userAnswer) {
  const prompts = {
    balagha: `ูู ุจุชุตุญูุญ ุงูุฅุฌุงุจุฉ ุงูุชุงููุฉ ุนูู ุชูุฑูู ุจูุงุบุฉ:
    
    ุงูุณุคุงู: ${question}
    
    ุฅุฌุงุจุฉ ุงูุทุงูุจ: ${userAnswer}
    
    ูู ุจุงูุชูููู ุญุณุจ:
    1. ุงูุฏูุฉ ุงูุนูููุฉ (40 ููุทุฉ)
    2. ุงูุงูุชูุงู (30 ููุทุฉ)
    3. ุงููุถูุญ (30 ููุทุฉ)
    
    ุฃุนุทู:
    - ุงูุฏุฑุฌุฉ ูู 100
    - ุงูุชุตููุจุงุช
    - ุงูุดุฑุญ
    - ูุตุงุฆุญ ููุชุญุณูู`,
    
    i3rab: `ูู ุจุชุตุญูุญ ุงูุฅุฌุงุจุฉ ุงูุชุงููุฉ ุนูู ุชูุฑูู ุฅุนุฑุงุจ:
    
    ุงูุณุคุงู: ${question}
    
    ุฅุฌุงุจุฉ ุงูุทุงูุจ: ${userAnswer}
    
    ูู ุจุงูุชูููู ุญุณุจ:
    1. ุตุญุฉ ุงูุฅุนุฑุงุจ (50 ููุทุฉ)
    2. ุงูุชูุงู ุงูุฅุฌุงุจุฉ (30 ููุทุฉ)
    3. ุงูุชุฑุชูุจ ูุงูุชูุธูู (20 ููุทุฉ)
    
    ุฃุนุทู:
    - ุงูุฏุฑุฌุฉ ูู 100
    - ุงูุชุตููุจุงุช ุงููุญููุฉ
    - ุดุฑุญ ุงูุฃุฎุทุงุก
    - ุงูุฅุนุฑุงุจ ุงูุตุญูุญ`,
    
    composition: `ูู ุจุชุตุญูุญ ุงููุถุนูุฉ ุงูุฅุฏูุงุฌูุฉ ุงูุชุงููุฉ:
    
    ุงูุณุคุงู: ${question}
    
    ุฅุฌุงุจุฉ ุงูุทุงูุจ: ${userAnswer}
    
    ูู ุจุงูุชูููู ุญุณุจ ุงููุนุงููุฑ:
    1. ุตุญุฉ ุงููุบุฉ ูุงููุญู (25 ููุทุฉ)
    2. ุงูุชูุธูู ูุงูุชุฑุงุจุท (25 ููุทุฉ)
    3. ุงูุบูู ุงููุบูู (25 ููุทุฉ)
    4. ุงูุฅุจุฏุงุน ูุงูุฃููุงุฑ (25 ููุทุฉ)
    
    ุฃุนุทู:
    - ุงูุฏุฑุฌุฉ ุงููููุฉ
    - ุชูููู ูู ูุนูุงุฑ
    - ููุงุท ุงูููุฉ
    - ููุงุท ุงูุถุนู
    - ุงูุชุฑุงุญุงุช`
  };
  
  return callDeepSeekAPI(prompts[exerciseType] || prompts.balagha);
}

/**
 * ุงูุงุชุตุงู ุจู DeepSeek API
 */
function callDeepSeekAPI(prompt) {
  try {
    const url = 'https://api.deepseek.com/v1/chat/completions';
    const payload = {
      model: "deepseek-chat",
      messages: [
        {
          role: "system",
          content: "ุฃูุช ูุณุงุนุฏ ุนุฑุจู ูุชุฎุตุต ูู ุงููุบุฉ ุงูุนุฑุจูุฉุ ุงูุจูุงุบุฉุ ุงููุญูุ ูุชูููู ุงููุชุงุจุฉ. ุฃุฌูุจ ุจุงูุนุฑุจูุฉ ููุท."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 2000
    };
    
    const options = {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const data = JSON.parse(response.getContentText());
    
    return {
      success: true,
      content: data.choices[0].message.content,
      raw: data
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message,
      content: "โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."
    };
  }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// 3. ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function saveResult(email, exerciseType, score, details) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.RESULTS);
    const timestamp = new Date().toLocaleString('ar-SA');
    
    sheet.appendRow([email, exerciseType, score, details, timestamp]);
    
    // ุชุญุฏูุซ ุงููุชุตุฏุฑูู
    updateLeaderboard(email, score, exerciseType);
    
    return { success: true, message: "ุชู ุญูุธ ุงููุชูุฌุฉ" };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

function updateLeaderboard(email, score, exerciseType) {
  try {
    const studentsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.STUDENTS);
    const studentsData = studentsSheet.getDataRange().getValues();
    
    let studentName = "ูุฌููู";
    for (let i = 1; i < studentsData.length; i++) {
      if (studentsData[i][0] === email) {
        studentName = studentsData[i][1];
        break;
      }
    }
    
    const leaderboardSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.LEADERBOARD);
    leaderboardSheet.appendRow([studentName, score, exerciseType, new Date().toLocaleString('ar-SA')]);
    
    // ุชุฑุชูุจ ุงููุชุตุฏุฑูู
    const lastRow = leaderboardSheet.getLastRow();
    if (lastRow > 10) {
      const dataRange = leaderboardSheet.getRange(2, 1, lastRow - 1, 4);
      const data = dataRange.getValues();
      
      data.sort((a, b) => b[1] - a[1]);
      const top10 = data.slice(0, 10);
      
      leaderboardSheet.getRange(2, 1, leaderboardSheet.getLastRow() - 1, 4).clear();
      if (top10.length > 0) {
        leaderboardSheet.getRange(2, 1, top10.length, 4).setValues(top10);
      }
    }
    
  } catch (error) {
    console.error("Error updating leaderboard:", error);
  }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// 4. ูุงุฌูุฉ API
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action;
    
    let response;
    
    switch (action) {
      case 'generate_exercise':
        const type = requestData.type;
        if (type === 'balagha') {
          response = generateBalaghaExercise();
        } else if (type === 'i3rab') {
          response = generateI3rabExercise();
        } else if (type === 'composition') {
          response = generateCompositionExercise();
        }
        break;
        
      case 'correct_answer':
        response = correctAnswer(
          requestData.exerciseType,
          requestData.question,
          requestData.userAnswer
        );
        break;
        
      case 'save_result':
        response = saveResult(
          requestData.email,
          requestData.exerciseType,
          requestData.score,
          requestData.details
        );
        break;
        
      case 'register':
        const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.STUDENTS);
        const timestamp = new Date().toLocaleString('ar-SA');
        sheet.appendRow([requestData.email, requestData.name, timestamp]);
        response = { success: true, message: "ุชู ุงูุชุณุฌูู" };
        break;
        
      case 'get_leaderboard':
        const leaderboardSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.LEADERBOARD);
        const data = leaderboardSheet.getDataRange().getValues();
        response = data.slice(1).map((row, index) => ({
          rank: index + 1,
          name: row[0],
          score: row[1],
          type: row[2],
          date: row[3]
        }));
        break;
        
      default:
        response = { success: false, message: "ุฅุฌุฑุงุก ุบูุฑ ูุนุฑูู" };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: "ุฎุทุฃ: " + error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({
      success: true,
      message: "ุฎุงุฏู ููุตุฉ ูุบุชู ูุนูู",
      version: "2.0",
      features: ["ุจูุงุบุฉ", "ุฅุนุฑุงุจ", "ูุถุนูุฉ ุฅุฏูุงุฌูุฉ"]
    }))
    .setMimeType(ContentService.MimeType.JSON);
}
